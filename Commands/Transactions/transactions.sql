/*
    Transactions


    üî∏ Atomicity (–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å)
    –í—Å—ë –∏–ª–∏ –Ω–∏—á–µ–≥–æ. –ï—Å–ª–∏ –æ–¥–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ —É–¥–∞–ª–∞—Å—å ‚Üí –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤—Å–µ.
    üî∏ Consistency (–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å)
    –ü–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–∞–∑–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
    üî∏ Isolation (–ò–∑–æ–ª—è—Ü–∏—è)
    –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –º–µ—à–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É (—Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏).
    üî∏ Durability (–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å)
    –ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞—Ü–∏–∏ (COMMIT) –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –ø—Ä–∏ —Å–±–æ–µ —Å–µ—Ä–≤–µ—Ä–∞.


    –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏:

    üîπ BEGIN TRANSACTION (–∏–ª–∏ BEGIN TRAN) ‚Äì –∫–æ–º–∞–Ω–¥–∞
    —Å–ª—É–∂–∏—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –í –∫–∞—á–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ –º–æ–∂–Ω–æ
    –ø–µ—Ä–µ–¥–∞—Ç—å –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
    üîπ COMMIT TRANSACTION (–∏–ª–∏ COMMIT TRAN) ‚Äì –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
    üîπ ROLLBACK TRANSACTION (–∏–ª–∏ ROLLBACK TRAN) ‚Äì –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.
    üîπ SAVE TRANSACTION (–∏–ª–∏ SAVE TRAN) ‚Äì –¥–∞–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ç–æ—á–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è 
    –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫ –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è, –≤ —Å–ª—É—á–∞–µ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
*/
-------------------------------------------------------------------

BEGIN TRY
-- –ù–∞—á–∞–ª–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
BEGIN TRANSACTION

	-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è 1 (—Ç—É—Ç –≤—Å–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
	UPDATE Products SET CategoryID = 2
	WHERE ProductID = 1

	-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è 2 (—Ç—É—Ç –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –æ—à–∏–±–∫–∞, —Ç.–∫. –ø–æ —É—Å–ª–æ–≤–∏—è–º —ç—Ç–æ–π —Ç–∞–±–ª–∏—Ü—ã –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å NULL –≤ CategoryID)
	UPDATE Products SET CategoryID = NULL
	WHERE ProductID = 2

	-- ... –î—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    
    -- –ï—Å–ª–∏ –≤—Å–µ —Ö–æ—Ä–æ—à–æ. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    COMMIT TRANSACTION

END TRY
BEGIN CATCH

	-- –í —Å–ª—É—á–∞–µ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–æ–π –æ—à–∏–±–∫–∏
	-- –û—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
	ROLLBACK TRANSACTION

	-- –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
	SELECT ERROR_NUMBER() AS [–ù–æ–º–µ—Ä –æ—à–∏–±–∫–∏],
		   ERROR_MESSAGE() AS [–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏]

	-- –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
	RETURN
END CATCH


--------------------------------------------
-- –µ—â–µ –æ–¥–∏–Ω –ø—Ä–∏–º–µ—Ä

BEGIN TRY
    BEGIN TRANSACTION;

        UPDATE Accounts
        SET Balance = Balance - 1000
        WHERE AccountID = 1;

        UPDATE Accounts
        SET Balance = Balance + 1000
        WHERE AccountID = 2;

    COMMIT TRANSACTION;
END TRY
BEGIN CATCH
    IF XACT_STATE() <> 0
        ROLLBACK TRANSACTION;

    THROW; -- –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
END CATCH;

--------------------------------------------
-- –≤–º–µ—Å—Ç–æ XACT_STATE() <> 0 –º–æ–∂–Ω–æ —Ç–∞–∫ –∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å @@ERROR <> 0, @@TRANCOUNT > 0

BEGIN CATCH
    IF @@ERROR <> 0
        ROLLBACK TRANSACTION;

    THROW; -- –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
END CATCH;

------

BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION;  

    THROW; -- –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
END CATCH;


----------------------------------------------
-- Best practice

BEGIN TRY
    BEGIN TRANSACTION;   -- –Ω–∞—á–∞–ª–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

    -- === –¢–≤–æ–π –∫–æ–¥ ===
    UPDATE Accounts
    SET Balance = Balance - 1000
    WHERE AccountID = 1;

    UPDATE Accounts
    SET Balance = Balance + 1000
    WHERE AccountID = 2;
    -- =================

    COMMIT TRANSACTION;  -- —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
END TRY
BEGIN CATCH
    -- –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION;  

    -- –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –Ω–∞–≤–µ—Ä—Ö (–∫–æ—Ä–æ—Ç–∫–æ –∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)
    THROW;
END CATCH;

-- ‚ùï –û–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç THROW, –∞ RAISERROR ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–≤–æ—ë –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Å–æ–±–∞—è –ª–æ–≥–∏–∫–∞.

------------------------------------------------------------------------
-- –ø—Ä–∏–º–µ—Ä —Å SAVE TRANSACTION

/*
    üîë –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

    1. –¢—ã –Ω–∞—á–∏–Ω–∞–µ—à—å –æ–¥–Ω—É –±–æ–ª—å—à—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.
    2. –í–Ω—É—Ç—Ä–∏ –Ω–µ—ë –≤—ã–ø–æ–ª–Ω—è–µ—à—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —à–∞–≥–æ–≤.
    3. –ï—Å–ª–∏ –≤ –∫–∞–∫–æ–º-—Ç–æ —à–∞–≥–µ –æ—à–∏–±–∫–∞ ‚Äî –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é, –∞ —Ç–æ–ª—å–∫–æ –¥–æ savepoint‚Äô–∞.
*/

BEGIN TRANSACTION;

    -- –ü–µ—Ä–≤—ã–π —à–∞–≥: –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç –∫–ª–∏–µ–Ω—Ç–∞
    UPDATE Accounts
    SET Balance = Balance - 1000
    WHERE AccountID = 1;

    -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    SAVE TRANSACTION Step1;

    -- –í—Ç–æ—Ä–æ–π —à–∞–≥: –ø–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ –¥—Ä—É–≥–æ–π —Å—á—ë—Ç
    BEGIN TRY
        UPDATE Accounts
        SET Balance = Balance + 1000
        WHERE AccountID = 999; -- –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–º, —á—Ç–æ —Ç–∞–∫–æ–≥–æ ID –Ω–µ—Ç
    END TRY
    BEGIN CATCH
        -- –û—à–∏–±–∫–∞ ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è —Ç–æ–ª—å–∫–æ –¥–æ Step1, –∞ –Ω–µ –≤–µ—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—à–Ω
        ROLLBACK TRANSACTION Step1;  
    END CATCH;

    -- –î–µ–ª–∞–µ–º –µ—â–µ —á—Ç–æ-—Ç–æ (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤—Å—ë –µ—â—ë –æ—Ç–∫—Ä—ã—Ç–∞)
    INSERT INTO Logs(Msg) 
    VALUES (N'–ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —á–∞—Å—Ç–∏—á–Ω–æ');

COMMIT TRANSACTION;
